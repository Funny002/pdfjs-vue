<template>
  <div ref="PdfJsVue" class="var-pdfJs" @mouseenter="onMouseenter" @mouseleave="onMouseleave">
    <div v-show="loading" class="var-pdfJs__loading">
      <div class="var-pdfJs__loading--box">
        <div class="var-pdfJs__loading--icon">
          <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M512 907c-24.852 0-45-20.148-45-45s20.148-45 45-45c168.446 0 305-136.554 305-305S680.446 207 512 207 207 343.554 207 512c0 24.852-20.148 45-45 45S117 536.852 117 512c0-218.152 176.848-395 395-395S907 293.848 907 512 730.152 907 512 907z"></path>
          </svg>
        </div>
        <div class="var-pdfJs__loading--text">加载中</div>
      </div>
    </div>
    <div class="var-pdfJs__header">
      <div class="var-pdfJs__header--title" :title="title">{{ title }}</div>
      <div class="var-pdfJs__nav">
        <div class="var-pdfJs__icon" title="缩小" @click="getZoom(false)">
          <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M304.810667 463.592727a31.030303 31.030303 0 0 1 31.030303-31.030303h248.242424a31.030303 31.030303 0 0 1 0 62.060606h-248.242424a31.030303 31.030303 0 0 1-31.030303-31.030303z"></path>
            <path d="M459.962182 168.804848a294.787879 294.787879 0 1 0 0 589.575758 294.787879 294.787879 0 0 0 0-589.575758z m-356.848485 294.787879c0-197.104485 159.77503-356.848485 356.848485-356.848485s356.848485 159.744 356.848485 356.848485c0 197.042424-159.77503 356.848485-356.848485 356.848485s-356.848485-159.806061-356.848485-356.848485z"></path>
            <path d="M668.392727 672.023273a31.030303 31.030303 0 0 1 43.907879 0l188.509091 188.540121a31.030303 31.030303 0 1 1-43.907879 43.876848l-188.47806-188.50909a31.030303 31.030303 0 0 1 0-43.907879z"></path>
          </svg>
        </div>
        <div style="padding: 0 5px;">
          <input ref="zoom" @blur="zoomBlur" class="var-pdfJs__nav--input"/>
        </div>
        <div class="var-pdfJs__icon" title="放大" @click="getZoom(true)">
          <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M304.810667 463.592727a31.030303 31.030303 0 0 1 31.030303-31.030303h248.242424a31.030303 31.030303 0 0 1 0 62.060606h-248.242424a31.030303 31.030303 0 0 1-31.030303-31.030303z"></path>
            <path d="M459.962182 308.441212a31.030303 31.030303 0 0 1 31.030303 31.030303v248.242424a31.030303 31.030303 0 1 1-62.060606 0v-248.242424a31.030303 31.030303 0 0 1 31.030303-31.030303z"></path>
            <path d="M459.962182 168.804848a294.787879 294.787879 0 1 0 0 589.575758 294.787879 294.787879 0 0 0 0-589.575758z m-356.848485 294.787879c0-197.104485 159.77503-356.848485 356.848485-356.848485s356.848485 159.744 356.848485 356.848485c0 197.042424-159.77503 356.848485-356.848485 356.848485s-356.848485-159.806061-356.848485-356.848485z"></path>
            <path d="M668.392727 672.023273a31.030303 31.030303 0 0 1 43.907879 0l188.509091 188.540121a31.030303 31.030303 0 1 1-43.907879 43.876848l-188.47806-188.50909a31.030303 31.030303 0 0 1 0-43.907879z"></path>
          </svg>
        </div>
        <div class="var-pdfJs__icon" @click="onResize" v-if="isResize" :class="{'var-pdfJs--resize': resize}" :title="`适应${resize ? '高' : '宽'}度`">
          <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M850.611 868.605H173.389c-68.925 0-125-56.075-125-125V280.394c0-68.925 56.075-125 125-125h677.222c68.925 0 125 56.075 125 125v463.211c0 68.925-56.075 125-125 125zM173.389 205.394c-41.355 0-75 33.645-75 75v463.211c0 41.355 33.645 75 75 75h677.222c41.355 0 75-33.645 75-75V280.394c0-41.355-33.645-75-75-75H173.389z"></path>
            <path d="M319.963 697.471c-13.807 0-25-11.193-25-25V352.502c0-13.807 11.193-25 25-25s25 11.193 25 25V672.47c0 13.807-11.193 25.001-25 25.001zM704.037 697.472c-13.807 0-25-11.193-25-25V352.503c0-13.807 11.193-25 25-25s25 11.193 25 25v319.968c0 13.807-11.193 25.001-25 25.001z"></path>
            <path d="M511.888 447.709m-35 0a35 35 0 1 0 70 0 35 35 0 1 0-70 0Z"></path>
            <path d="M511.888 576.046m-35 0a35 35 0 1 0 70 0 35 35 0 1 0-70 0Z"></path>
          </svg>
        </div>
        <div class="var-pdfJs__link-h"></div>
        <div class="var-pdfJs__icon" title="上一页" @click="setPage(page - 1)">
          <svg viewBox="0 0 1383 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M1214.867064 541.881191c-100.155915-122.259064-288.866043-267.765106-621.578894-280.260085V35.262638c0-13.322894-7.636426-25.817872-19.804596-31.482553s-26.591319-3.965277-36.776851 4.542638l-523.982978 433.130213A34.946723 34.946723 0 0 0 0 468.142298c0 10.490553 4.531745 20.131404 12.451404 26.656681l523.972085 434.851404c10.457872 8.497021 24.619574 10.490553 36.776851 4.531745a34.467404 34.467404 0 0 0 19.804596-31.482554v-225.497872c217.284085 0.838809 549.430468 17.004936 725.700085 328.747575a34.565447 34.565447 0 0 0 30.262468 17.593191c2.83234 0 5.947915-0.294128 8.780256-1.14383A34.554553 34.554553 0 0 0 1383.489362 988.922553c0.283234-116.583489-44.140936-294.999149-168.622298-447.041362z m-656.384 65.797447a34.805106 34.805106 0 0 0-34.794213 34.892256v186.368L89.403915 468.414638l434.56817-359.402212v186.368a34.892255 34.892255 0 0 0 34.238638 34.892255c497.947234 4.814979 683.530894 309.182638 737.574128 523.057021-214.451745-245.356936-535.573787-245.651064-737.301787-245.651064z"></path>
          </svg>
        </div>
        <div style="display: flex; align-items: center; padding: 0 5px;">
          <input ref="page" @blur="pageBlur" class="var-pdfJs__nav--input"/>
          <div style="padding: 0 5px; user-select: none;">/</div>
          <div style="user-select: none;">{{ max }}</div>
        </div>
        <div class="var-pdfJs__icon" title="下一页" @click="setPage(page + 1)">
          <svg viewBox="0 0 1383 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M168.906403 541.794043C44.425042 693.553021 0.000871 872.262809 0.000871 988.835404a34.314894 34.314894 0 0 0 25.741618 33.476085c2.83234 0.849702 5.947915 1.132936 8.780255 1.132937a35.251745 35.251745 0 0 0 30.262468-17.582298c176.258723-311.448511 508.699234-327.908766 725.700085-328.769362v225.51966c0 13.333787 7.636426 25.817872 19.804596 31.482553s26.591319 3.97617 36.776851-4.542639l523.982979-434.557276A34.674383 34.674383 0 0 0 1383.490233 468.327489c0-10.490553-4.531745-20.131404-12.734638-26.65668L847.349978 8.518809c-10.457872-8.497021-24.619574-10.490553-36.776851-4.531745a34.467404 34.467404 0 0 0-19.804596 31.482553v226.369362c-333.279319 12.189957-521.706213 157.706894-621.862128 279.965957z m656.667234-211.608511a34.707064 34.707064 0 0 0 34.227745-34.881362V108.93617l434.56817 359.391319-434.56817 360.535149V642.494638a35.295319 35.295319 0 0 0-10.185532-24.674042 34.619915 34.619915 0 0 0-24.619574-10.218213c-201.717106 0-522.555915 0-737.28 245.651064 54.03234-213.874383 239.910128-518.242043 737.846468-523.067915z"></path>
          </svg>
        </div>
        <div class="var-pdfJs__link-h mini-none"></div>
      </div>
      <div class="var-pdfJs__header--button">
        <slot name="download">
          <div v-if="download" class="var-pdfJs__icon" title="下载" @click="e => onClick('download', e)">
            <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
              <path d="M868.100096 742.600704l-0.049152 0L216.246272 742.600704l-0.049152 0c-13.98784 0-25.327616 11.33568-25.327616 25.352192 0 13.993984 11.360256 25.327616 25.327616 25.327616l0.049152 0 651.804672 0 0.049152 0c13.996032 0 25.33376-11.333632 25.33376-25.327616C893.431808 753.936384 882.096128 742.600704 868.100096 742.600704L868.100096 742.600704 868.100096 742.600704M523.15136 688.433152c4.728832 4.757504 11.237376 7.733248 18.47296 7.733248l0 0 0 0c7.231488 0 13.740032-2.951168 18.42176-7.757824l314.836992-314.83904c4.732928-4.704256 7.714816-11.214848 7.7312-18.395136 0-14.342144-11.712512-25.9584-25.972736-25.9584-7.213056-0.02048-13.694976 2.930688-18.376704 7.636992L567.578624 607.51872 567.578624 117.52448c-0.024576-0.026624-0.024576-0.026624-0.024576-0.0512 0.024576-14.344192-11.59168-25.980928-25.901056-25.980928-14.348288 0-25.960448 11.634688-25.960448 25.980928 0 0 0 0.024576 0.024576 0.0512l0 489.967616L245.055488 336.826368c-4.683776-4.704256-11.2128-7.6288-18.374656-7.60832-14.342144-0.02048-25.954304 11.614208-26.005504 25.9072 0 7.20896 2.951168 13.768704 7.684096 18.423808L523.15136 688.433152 523.15136 688.433152 523.15136 688.433152M523.15136 688.433152 523.15136 688.433152z"></path>
            </svg>
          </div>
        </slot>
        <slot name="print">
          <div v-if="print" class="var-pdfJs__icon" title="打印" @click="e => onClick('print', e)">
            <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
              <path d="M820 436h-40c-4.4 0-8 3.6-8 8v40c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-40c0-4.4-3.6-8-8-8zM852 332H732V120c0-4.4-3.6-8-8-8H300c-4.4 0-8 3.6-8 8v212H172c-44.2 0-80 35.8-80 80v328c0 17.7 14.3 32 32 32h168v132c0 4.4 3.6 8 8 8h424c4.4 0 8-3.6 8-8V772h168c17.7 0 32-14.3 32-32V412c0-44.2-35.8-80-80-80zM360 180h304v152H360V180z m304 664H360V568h304v276z m200-140H732V500H292v204H160V412c0-6.6 5.4-12 12-12h680c6.6 0 12 5.4 12 12v292z"></path>
            </svg>
          </div>
        </slot>
        <div class="var-pdfJs__icon" @click="onFullscreen(!isFullscreen)" :title="!isFullscreen ? '全屏' : '退出全屏'">
          <svg v-if="isFullscreen" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M384 350.848c0 0.192-0.128 0.384-0.128 0.64C383.872 351.68 384 351.872 384 352.064 384 360.32 380.544 367.68 375.232 373.312 374.912 373.632 374.784 374.08 374.528 374.336c-1.024 1.024-2.432 1.664-3.584 2.56C365.504 381.056 359.168 384 351.936 384 351.744 384 351.616 383.936 351.424 383.936S351.04 384 350.848 384L97.28 384C78.72 384 64 369.664 64 352 63.872 334.4 78.848 320 97.152 320l177.6 0L73.984 119.36C60.992 106.304 60.672 85.632 73.216 73.216c12.352-12.608 33.152-12.16 46.08 0.832l200.704 200.704L320 97.216C319.936 78.784 334.4 64 352 64 369.6 63.872 384 78.848 384 97.152L384 350.848zM862.848 320l-177.6 0 200.768-200.704c12.992-13.056 13.312-33.664 0.832-46.144-12.352-12.608-33.152-12.16-46.08 0.832l-200.704 200.704L640.064 97.216C640.064 78.784 625.6 64 608 64 590.4 63.872 576 78.848 576 97.152l0 253.696c0 0.192 0.128 0.384 0.128 0.64C576.128 351.68 576 351.872 576 352.064 576 360.32 579.456 367.68 584.768 373.312c0.32 0.32 0.448 0.768 0.768 1.024 1.024 1.024 2.432 1.664 3.648 2.56C594.496 381.056 600.832 384 608.064 384c0.192 0 0.32-0.064 0.512-0.064S608.96 384 609.152 384l253.632 0C881.28 384 896 369.664 896 352 896.128 334.4 881.152 320 862.848 320zM384 608c0-8.256-3.456-15.552-8.768-21.248C374.912 586.432 374.784 585.984 374.528 585.664 373.44 584.704 372.096 584.064 370.944 583.168 365.568 579.008 359.168 576 351.936 576 351.744 576 351.616 576.128 351.424 576.128S351.04 576 350.848 576L97.28 576C78.72 576 64 590.4 64 608 63.872 625.6 78.848 640 97.152 640l177.6 0-200.768 200.768c-12.992 12.992-13.312 33.6-0.832 46.144 12.352 12.608 33.152 12.096 46.08-0.896l200.704-200.704 0 177.536c0 18.368 14.464 33.28 32.064 33.152C369.6 896.256 384 881.28 384 862.848L384 609.28c0-0.256-0.128-0.448-0.128-0.64C383.872 608.384 384 608.192 384 608zM685.248 640l177.6 0c18.24 0 33.28-14.4 33.152-32C896 590.4 881.28 576 862.72 576L609.152 576C608.96 576 608.768 576.128 608.576 576.128S608.256 576 608.064 576C600.832 576 594.432 579.008 589.056 583.168 587.904 584.064 586.56 584.704 585.472 585.664 585.216 585.984 585.088 586.432 584.768 586.752 579.456 592.448 576 599.744 576 608c0 0.192 0.128 0.384 0.128 0.64C576.128 608.832 576 609.024 576 609.28l0 253.632C576 881.28 590.4 896.256 608 896c17.6 0.128 32.064-14.72 32.064-33.152l0-177.536 200.704 200.704c12.928 12.992 33.664 13.504 46.08 0.896 12.48-12.48 12.16-33.152-0.832-46.144L685.248 640z"></path>
          </svg>
          <svg v-else viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" height="128" width="128">
            <path d="M149.333 394.667c17.067 0 32-14.934 32-32V226.133l187.734 187.734c6.4 6.4 14.933 8.533 23.466 8.533s17.067-2.133 23.467-8.533c12.8-12.8 12.8-32 0-44.8L228.267 181.333h134.4c17.066 0 32-14.933 32-32s-14.934-32-32-32H149.333c-4.266 0-8.533 0-10.666 2.134-8.534 4.266-14.934 10.666-19.2 17.066-2.134 4.267-2.134 8.534-2.134 12.8v213.334c0 17.066 14.934 32 32 32z m725.334 234.666c-17.067 0-32 14.934-32 32v136.534L642.133 597.333c-12.8-12.8-32-12.8-44.8 0s-12.8 32 0 44.8l200.534 200.534H661.333c-17.066 0-32 14.933-32 32s14.934 32 32 32h213.334c4.266 0 8.533 0 10.666-2.134 8.534-4.266 14.934-8.533 17.067-17.066 2.133-4.267 2.133-8.534 2.133-10.667V661.333c2.134-17.066-12.8-32-29.866-32z m-492.8-34.133L181.333 795.733v-134.4c0-17.066-14.933-32-32-32s-32 14.934-32 32v213.334c0 4.266 0 8.533 2.134 10.666 4.266 8.534 8.533 14.934 17.066 17.067 4.267 2.133 8.534 2.133 10.667 2.133h213.333c17.067 0 32-14.933 32-32s-14.933-32-32-32H224L424.533 640c12.8-12.8 12.8-32 0-44.8s-29.866-10.667-42.666 0z m522.666-456.533c0-2.134 0-2.134 0 0-4.266-8.534-10.666-14.934-17.066-17.067-4.267-2.133-8.534-2.133-10.667-2.133H661.333c-17.066 0-32 14.933-32 32s14.934 32 32 32h136.534L610.133 371.2c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 14.934 8.533 23.467 8.533s17.067-2.133 23.467-8.533L844.8 228.267v134.4c0 17.066 14.933 32 32 32s32-14.934 32-32V149.333c-2.133-4.266-2.133-8.533-4.267-10.666z"></path>
          </svg>
        </div>
      </div>
    </div>
    <div class="var-pdfJs__body">
      <slot></slot>
    </div>
  </div>
</template>

<script>
const zoomList = [25, 33, 50, 67, 75, 80, 90, 100, 110, 125, 150, 175, 200, 300, 400, 500]
import {PropBoolean, PropNumber, PropString} from '../utils/Props'
import {Size as LimitSize} from '../utils/Limit'
import Fullscreen from '../utils/fullScreen'

export default {
  name: 'PdfBox',
  props: {
    max: PropNumber(1),
    page: PropNumber(1),
    zoom: PropNumber(80),
    title: PropString(''),
    print: PropBoolean(true),
    resize: PropBoolean(false),
    loading: PropBoolean(false),
    download: PropBoolean(true),
    isResize: PropBoolean(false)
  },
  data: function () {
    return {
      Fullscreen: null,
      isFullscreen: false
    }
  },
  watch: {
    zoom (val) {
      this.$refs.zoom.value = val.toString() + '%'
    },
    page (val) {
      this.$refs.page.value = val.toString()
    }
  },
  mounted () {
    window.addEventListener('resize', this.rePdfSize)
    //
    const zoom = this.$refs.zoom
    zoom.value = this.zoom.toString() + '%'
    zoom.oninput = () => {
      let val = zoom.value.replace(/[^\d]/g, '')
      if (val) val += '%'
      zoom.value = val
    }
    //
    const page = this.$refs.page
    page.value = this.page.toString()
    page.oninput = () => {
      page.value = page.value.replace(/[^\d]/g, '')
    }
  },
  destroyed () {
    window.removeEventListener('resize', this.rePdfSize)
  },
  methods: {
    onMouseleave () {
      window.removeEventListener('mousewheel', this.onMouseWheel)
      window.removeEventListener('DOMMouseScroll', this.onMouseWheel)
    },
    onMouseenter () {
      window.addEventListener('mousewheel', this.onMouseWheel, {passive: false})
      window.addEventListener('DOMMouseScroll', this.onMouseWheel, {passive: false})
    },
    onMouseWheel (event) {
      if (event.ctrlKey) {
        event.preventDefault()
        // 火狐，IE9，Chrome
        this.getZoom((event.detail || event.deltaY) < 0)
      }
    },
    setZoom (zoom) {
      zoom = LimitSize(zoom, 25, 500)
      this.$emit('change', 'zoom', zoom)
    },
    setPage (page) {
      page = LimitSize(page, 1, this.max)
      this.$emit('change', 'page', page)
    },
    zoomBlur (event) {
      this.setZoom(parseInt(event.target.value.replace(/[^\d]/g, '') || '0'))
    },
    pageBlur (event) {
      this.setPage(parseInt(event.target.value || '0'))
    },
    getZoom (state = false) {
      for (const key in zoomList) {
        if (zoomList[key] >= this.zoom) {
          if (state && zoomList[key] !== this.zoom) {
            return this.setZoom(zoomList[key])
          }
          const keys = LimitSize(parseInt(key) + (state ? 1 : -1), 0, 15)
          return this.setZoom(zoomList[keys])
        }
      }
    },
    onResize () {
      this.$emit('resize', this.resize)
    },
    onClick (name, event) {
      this.$emit(name, event)
    },
    rePdfSize () {
      if (this.Fullscreen) this.isFullscreen = this.Fullscreen.has()
    },
    onFullscreen (state) {
      if (state) {
        this.Fullscreen = Fullscreen(this.$refs.PdfJsVue)
      } else {
        this.Fullscreen.close()
      }
    }
  }
}
</script>